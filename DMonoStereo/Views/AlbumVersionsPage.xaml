<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:DMonoStereo.Views"
             xmlns:models="clr-namespace:DMonoStereo.Models"
             xmlns:converters="clr-namespace:DMonoStereo.Converters"
             x:Class="DMonoStereo.Views.AlbumVersionsPage"
             x:DataType="views:AlbumVersionsPage"
             Title="{Binding AlbumTitle}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:ByteArrayToImageSourceConverter x:Key="ByteArrayToImageSourceConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="20" RowSpacing="15" RowDefinitions="Auto,Auto,*,Auto,Auto">
        <!-- Фильтры -->
        <Border Grid.Row="0"
                StrokeThickness="0"
                BackgroundColor="{DynamicResource CardBackgroundColor}"
                Padding="15">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="15" />
            </Border.StrokeShape>
            <VerticalStackLayout Spacing="15">
                <Button Text="Фильтры"
                        Clicked="OnFiltersToggleClicked"
                        HorizontalOptions="Start"
                        Style="{StaticResource SecondaryButtonStyle}" />
                
                <Grid IsVisible="{Binding AreFiltersVisible}"
                      RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                      RowSpacing="10">
                    <!-- Фильтр по формату -->
                    <Grid Grid.Row="0"
                          IsVisible="{Binding HasFormatFilters}"
                          RowDefinitions="Auto,*"
                          RowSpacing="5">
                        <Label Grid.Row="0"
                               Text="Формат"
                               FontAttributes="Bold"
                               FontSize="16" />
                        <CollectionView Grid.Row="1"
                                        ItemsSource="{Binding FormatFilters}"
                                        SelectedItem="{Binding SelectedFormat}"
                                        SelectionMode="Single"
                                        SelectionChanged="OnFilterSelectionChanged"
                                        HeightRequest="150">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="5" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:MusicFilterOption">
                                    <Border StrokeThickness="1"
                                            Stroke="{DynamicResource SecondaryTextColor}"
                                            BackgroundColor="{DynamicResource PageBackgroundColor}"
                                            Padding="10">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="8" />
                                        </Border.StrokeShape>
                                        <Label Text="{Binding Title}"
                                               FontSize="14" />
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>

                    <!-- Фильтр по стране -->
                    <Grid Grid.Row="1"
                          IsVisible="{Binding HasCountryFilters}"
                          RowDefinitions="Auto,*"
                          RowSpacing="5">
                        <Label Grid.Row="0"
                               Text="Страна"
                               FontAttributes="Bold"
                               FontSize="16" />
                        <CollectionView Grid.Row="1"
                                        ItemsSource="{Binding CountryFilters}"
                                        SelectedItem="{Binding SelectedCountry}"
                                        SelectionMode="Single"
                                        SelectionChanged="OnFilterSelectionChanged"
                                        HeightRequest="150">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="5" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:MusicFilterOption">
                                    <Border StrokeThickness="1"
                                            Stroke="{DynamicResource SecondaryTextColor}"
                                            BackgroundColor="{DynamicResource PageBackgroundColor}"
                                            Padding="10">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="8" />
                                        </Border.StrokeShape>
                                        <Label Text="{Binding Title}"
                                               FontSize="14" />
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>

                    <!-- Фильтр по году -->
                    <Grid Grid.Row="2"
                          IsVisible="{Binding HasYearFilters}"
                          RowDefinitions="Auto,*"
                          RowSpacing="5">
                        <Label Grid.Row="0"
                               Text="Год"
                               FontAttributes="Bold"
                               FontSize="16" />
                        <CollectionView Grid.Row="1"
                                        ItemsSource="{Binding YearFilters}"
                                        SelectedItem="{Binding SelectedYear}"
                                        SelectionMode="Single"
                                        SelectionChanged="OnFilterSelectionChanged"
                                        HeightRequest="150">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="5" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:MusicFilterOption">
                                    <Border StrokeThickness="1"
                                            Stroke="{DynamicResource SecondaryTextColor}"
                                            BackgroundColor="{DynamicResource PageBackgroundColor}"
                                            Padding="10">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="8" />
                                        </Border.StrokeShape>
                                        <Label Text="{Binding Title}"
                                               FontSize="14" />
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>

                    <!-- Примененные фильтры -->
                    <Label Grid.Row="3"
                           Text="{Binding AppliedFiltersText}"
                           FontSize="14"
                           TextColor="{DynamicResource SecondaryTextColor}"
                           IsVisible="{Binding HasActiveFilters}" />

                    <!-- Кнопка сброса фильтров -->
                    <Button Grid.Row="4"
                            Text="Сбросить фильтры"
                            Clicked="OnResetFiltersClicked"
                            IsVisible="{Binding HasActiveFilters}"
                            Style="{StaticResource SecondaryButtonStyle}"
                            HorizontalOptions="Start" />
                </Grid>
            </VerticalStackLayout>
        </Border>

        <CollectionView Grid.Row="2"
                        ItemsSource="{Binding Versions}"
                        SelectionMode="Single"
                        SelectionChanged="OnVersionSelected">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="15" />
            </CollectionView.ItemsLayout>
            <CollectionView.EmptyView>
                <Label Text="{Binding EmptyStateText}"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{DynamicResource SecondaryTextColor}" />
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:MusicAlbumVersionSummary">
                    <Border StrokeThickness="0"
                            BackgroundColor="{DynamicResource CardBackgroundColor}"
                            Padding="15">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="15" />
                        </Border.StrokeShape>
                        <Grid ColumnDefinitions="Auto,*"
                              ColumnSpacing="15">
                            <Border Grid.Column="0"
                                    WidthRequest="72"
                                    HeightRequest="72"
                                    Padding="0"
                                    BackgroundColor="{DynamicResource PageBackgroundColor}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="15" />
                                </Border.StrokeShape>
                                <Image Source="{Binding CoverImageData, Converter={StaticResource ByteArrayToImageSourceConverter}}"
                                       Aspect="AspectFill" />
                            </Border>

                            <VerticalStackLayout Grid.Column="1"
                                                 Spacing="4"
                                                 VerticalOptions="Center">
                                <Label Text="{Binding Title}"
                                       FontAttributes="Bold"
                                       FontSize="18"
                                       LineBreakMode="WordWrap" />
                                <Label Text="{Binding Format, StringFormat='Формат: {0}'}"
                                       FontSize="14"
                                       TextColor="{DynamicResource SecondaryTextColor}">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label"
                                                     Binding="{Binding Format}"
                                                     Value="{x:Null}">
                                            <Setter Property="IsVisible" Value="False" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                                <Label Text="{Binding Country, StringFormat='Страна: {0}'}"
                                       FontSize="14"
                                       TextColor="{DynamicResource SecondaryTextColor}">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label"
                                                     Binding="{Binding Country}"
                                                     Value="{x:Null}">
                                            <Setter Property="IsVisible" Value="False" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </VerticalStackLayout>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <Grid Grid.Row="3"
              ColumnDefinitions="Auto,*,*,Auto"
              ColumnSpacing="15">
            <Button Grid.Column="0"
                    Text="«"
                    Style="{StaticResource PrimaryButtonStyle}"
                    FontSize="25"
                    Clicked="OnFirstClicked"
                    IsEnabled="{Binding IsFirstEnabled}" />
            <Button Grid.Column="1"
                    Text="‹"
                    Style="{StaticResource PrimaryButtonStyle}"
                    FontSize="25"
                    Clicked="OnPreviousClicked"
                    IsEnabled="{Binding IsPreviousEnabled}" />
            <Button Grid.Column="2"
                    Text="›"
                    Style="{StaticResource PrimaryButtonStyle}"
                    FontSize="25"
                    Clicked="OnNextClicked"
                    IsEnabled="{Binding IsNextEnabled}" />
            <Button Grid.Column="3"
                    Text="»"
                    Style="{StaticResource PrimaryButtonStyle}"
                    FontSize="25"
                    Clicked="OnLastClicked"
                    IsEnabled="{Binding IsLastEnabled}" />
        </Grid>

        <Label Grid.Row="4"
               Text="{Binding PageStatusText}"
               HorizontalOptions="Center"
               TextColor="{DynamicResource SecondaryTextColor}">
            <Label.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnPageStatusTapped" NumberOfTapsRequired="1" />
            </Label.GestureRecognizers>
        </Label>
    </Grid>
</ContentPage>

